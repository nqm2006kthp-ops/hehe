<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Magic Christmas for Her</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <style>
        /* Th·∫©m m·ªπ t·ª´ Project 1 & 7 */
        :root { --gold: #FFD700; --bg: #050505; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Cinzel', serif; }

        /* N√∫t b·∫•m t·ª´ Project 1 */
        #start-screen {
            position: fixed; inset: 0; z-index: 1000; background: radial-gradient(circle, #1a0a0a, #000);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .btn-magic {
            background: var(--gold); color: #000; border: none; padding: 22px 65px;
            font-size: 26px; font-weight: 900; border-radius: 60px; cursor: pointer;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.4); transition: 0.5s;
            letter-spacing: 4px; animation: glow 2s infinite;
        }
        .btn-magic:hover { transform: scale(1.1); background: #fff; box-shadow: 0 0 70px var(--gold); }

        /* Giao di·ªán K√≠nh m·ªù (Glassmorphism) t·ª´ Project 7 */
        #ui-layer {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px);
            padding: 20px 40px; border-radius: 30px; border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--gold); text-align: center; z-index: 100; opacity: 0; pointer-events: none;
        }

        @keyframes glow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        #webcam-view { position: absolute; top: 20px; left: 20px; width: 160px; border-radius: 12px; border: 1px solid var(--gold); opacity: 0.4; transform: scaleX(-1); }
    </style>
</head>
<body>

    <div id="start-screen">
        <button class="btn-magic" onclick="startMagic()">B·∫ÆT ƒê·∫¶U PH√âP M√ÄU</button>
        <p style="color: var(--gold); margin-top: 25px; font-size: 14px; opacity: 0.8;">D√†nh t·∫∑ng ng∆∞·ªùi ƒë·∫∑c bi·ªát nh·∫•t c·ªßa anh</p>
    </div>

    <div id="ui-layer">
        <div id="status">ƒêang kh·ªüi t·∫°o linh h·ªìn c·ªßa Gi√°ng sinh...</div>
    </div>

    <video class="input_video" style="display:none"></video>
    <canvas id="webcam-view"></canvas>
    <div id="scene-container"></div>

    <script>
        let scene, camera, renderer, particles, clock = new THREE.Clock();
        let pTree, pHeart, pNeural, pScatter;
        let state = 'TREE'; 
        const P_COUNT = 8000; // C√¢n b·∫±ng ƒë·ªô ph·ª©c t·∫°p v√† hi·ªáu su·∫•t

        async function startMagic() {
            // Chuy·ªÉn c·∫£nh chuy√™n nghi·ªáp t·ª´ Project 3
            gsap.to("#start-screen", { y: "-100%", duration: 1.2, ease: "power4.inOut", onComplete: () => {
                document.getElementById("start-screen").style.display = "none";
                gsap.to("#ui-layer", { opacity: 1, duration: 1 });
                init3D();
                initAI();
            }});
        }

        function createPositions() {
            pTree = new Float32Array(P_COUNT * 3);
            pHeart = new Float32Array(P_COUNT * 3);
            pNeural = new Float32Array(P_COUNT * 3);

            for (let i = 0; i < P_COUNT; i++) {
                // Logic C√¢y th√¥ng Grand Luxury (Project 6)
                const h = Math.random() * 80;
                const r = ((80 - h) / 80) * 35 * Math.sqrt(Math.random());
                const angle = Math.random() * Math.PI * 2;
                pTree[i*3] = r * Math.cos(angle);
                pTree[i*3+1] = h - 40;
                pTree[i*3+2] = r * Math.sin(angle);

                // Logic Tr√°i tim Neon (Project 5)
                const t = (i / P_COUNT) * Math.PI * 2;
                pHeart[i*3] = (16 * Math.pow(Math.sin(t), 3)) * 2.8;
                pHeart[i*3+1] = (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * 2.8;
                pHeart[i*3+2] = (Math.random() - 0.5) * 10;

                // Logic M·∫°ng l∆∞·ª£ng t·ª≠ (Project 7)
                const phi = Math.acos(2 * Math.random() - 1);
                const theta = 2 * Math.PI * Math.random();
                pNeural[i*3] = 45 * Math.sin(phi) * Math.cos(theta);
                pNeural[i*3+1] = 45 * Math.sin(phi) * Math.sin(theta);
                pNeural[i*3+2] = 45 * Math.cos(phi);
            }
        }

        function init3D() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.005); // Chi·ªÅu s√¢u t·ª´ Project 7
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(0, 15, 120);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('scene-container').appendChild(renderer.domElement);

            createPositions();

            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(pTree), 3));
            
            // Texture ph√°t s√°ng t·ª´ Project 5
            const mat = new THREE.PointsMaterial({
                color: 0xFFD700, size: 0.9, transparent: true,
                blending: THREE.AdditiveBlending, depthWrite: false, opacity: 0.8
            });

            particles = new THREE.Points(geo, mat);
            scene.add(particles);

            // Th√™m √°nh s√°ng r·ª±c r·ª° (Bloom effect logic)
            const light = new THREE.PointLight(0xffaa00, 2, 100);
            scene.add(light);

            animate();
        }

        function initAI() {
            const video = document.getElementsByClassName('input_video')[0];
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.85 });

            hands.onResults(results => {
                const status = document.getElementById('status');
                if (results.multiHandLandmarks && results.multiHandLandmarks.length === 2) {
                    state = 'HEART';
                    status.innerText = "‚ù§Ô∏è TR√ÅI TIM D√ÄNH CHO EM ‚ù§Ô∏è";
                    gsap.to(particles.material.color, { r: 1, g: 0.1, b: 0.4 }); // H·ªìng Neon
                } else if (results.multiHandLandmarks && results.multiHandLandmarks.length === 1) {
                    state = 'NEURAL';
                    status.innerText = "‚ú® K·∫æT N·ªêI LINH H·ªíN ‚ú®";
                    gsap.to(particles.material.color, { r: 0.2, g: 0.8, b: 1 }); // Xanh L∆∞·ª£ng t·ª≠
                } else {
                    state = 'TREE';
                    status.innerText = "‚úä N·∫Øm tay: C√¢y th√¥ng | ü´∂ 2 tay: Tr√°i tim | üëã X√≤e tay: V≈© tr·ª•";
                    gsap.to(particles.material.color, { r: 1, g: 0.84, b: 0 }); // V√†ng Kim
                }
            });

            const cam = new Camera(video, { onFrame: async () => { await hands.send({image: video}); }, width: 640, height: 480 });
            cam.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            const pos = particles.geometry.attributes.position.array;
            let target = pTree;

            if (state === 'HEART') target = pHeart;
            else if (state === 'NEURAL') target = pNeural;

            // Thu·∫≠t to√°n Morphing m∆∞·ª£t m√† (Lerp)
            for (let i = 0; i < pos.length; i++) {
                let drift = (state === 'NEURAL') ? Math.sin(time + i) * 0.1 : 0;
                pos[i] += (target[i] - pos[i]) * 0.07 + drift;
            }

            particles.geometry.attributes.position.needsUpdate = true;
            particles.rotation.y += 0.004;

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>