<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Magic for Her</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <style>
        /* CSS k·∫øt h·ª£p Project 1 & 7: Glassmorphism & Luxury Button */
        :root { --gold: #FFD700; --red: #D32F2F; --glass: rgba(255, 255, 255, 0.1); }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Cinzel', serif; }

        #start-overlay {
            position: fixed; inset: 0; z-index: 1000; background: radial-gradient(circle, #1a0505, #000);
            display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 1s;
        }

        /* Magic Button from Project 1 */
        .play-btn {
            background: var(--gold); color: #000; border: none; padding: 20px 60px;
            font-size: 24px; font-weight: 900; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5); transition: 0.4s;
            letter-spacing: 5px; animation: pulse 2s infinite;
        }
        .play-btn:hover { transform: scale(1.1) rotate(2deg); background: #fff; }

        /* UI Panel from Project 7 */
        #ui-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--glass); backdrop-filter: blur(15px); padding: 15px 30px;
            border-radius: 20px; border: 1px solid rgba(255,215,0,0.2); color: var(--gold);
            text-align: center; pointer-events: none; z-index: 100; opacity: 0;
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 30px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
        #webcam-view { position: absolute; top: 20px; left: 20px; width: 150px; border-radius: 10px; transform: scaleX(-1); border: 1px solid var(--gold); opacity: 0.5; }
    </style>
</head>
<body>

    <div id="start-overlay">
        <button class="play-btn" onclick="launchGift()">OPEN GIFT</button>
        <p style="color: var(--gold); margin-top: 20px; letter-spacing: 2px;">A little magic for you</p>
    </div>

    <div id="ui-panel">
        <div id="gesture-hint">Show your hand to interact...</div>
    </div>

    <video class="input_video" style="display:none"></video>
    <canvas id="webcam-view"></canvas>
    <div id="container"></div>

    <script>
        // --- CHU·∫®N B·ªä BI·∫æN T·ª™ C√ÅC PROJECT ---
        let scene, camera, renderer, composer, clock = new THREE.Clock();
        let particles, goldData, heartData, neuralData;
        let state = 'TREE'; // TREE, HEART, NEURAL
        
        // C·∫•u h√¨nh t·ªëi ∆∞u (Balanced)
        const P_COUNT = 6000; 

        async function launchGift() {
            // Hi·ªáu ·ª©ng chuy·ªÉn c·∫£nh tr∆∞·ª£t t·ª´ Project 3
            gsap.to("#start-overlay", { y: "-100%", duration: 1.5, ease: "expo.inOut", onComplete: () => {
                document.getElementById("ui-panel").style.opacity = 1;
                initThree();
                initAI();
            }});
        }

        // To√°n h·ªçc h√¨nh tr√°i tim t·ª´ Project 5
        function getHeartPoint(t) {
            const x = 16 * Math.pow(Math.sin(t), 3);
            const y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
            return new THREE.Vector3(x * 2.5, y * 2.5, (Math.random()-0.5) * 10);
        }

        function initThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.008); // Fog t·ª´ Project 7
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000);
            camera.position.set(0, 10, 100);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('container').appendChild(renderer.domElement);

            // Tinh hoa Project 6: Grand Luxury Tree
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(P_COUNT * 3);
            goldData = new Float32Array(P_COUNT * 3);
            heartData = new Float32Array(P_COUNT * 3);
            neuralData = new Float32Array(P_COUNT * 3);

            for(let i=0; i<P_COUNT; i++) {
                // C√¢y th√¥ng (Project 6)
                const h = Math.random() * 70;
                const r = ((70-h)/70) * 35 * Math.sqrt(Math.random());
                const ang = Math.random() * Math.PI * 2;
                goldData[i*3] = r * Math.cos(ang);
                goldData[i*3+1] = h - 35;
                goldData[i*3+2] = r * Math.sin(ang);

                // Tr√°i tim (Project 5)
                const hp = getHeartPoint((i/P_COUNT) * Math.PI * 2);
                heartData[i*3] = hp.x; heartData[i*3+1] = hp.y; heartData[i*3+2] = hp.z;

                // M·∫°ng th·∫ßn kinh Sphere (Project 7)
                const phi = Math.acos(2 * Math.random() - 1);
                const theta = 2 * Math.PI * Math.random();
                const sr = 40;
                neuralData[i*3] = sr * Math.sin(phi) * Math.cos(theta);
                neuralData[i*3+1] = sr * Math.sin(phi) * Math.sin(theta);
                neuralData[i*3+2] = sr * Math.cos(phi);
                
                pos[i*3] = goldData[i*3]; pos[i*3+1] = goldData[i*3+1]; pos[i*3+2] = goldData[i*3+2];
            }

            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            
            // Ch·∫•t li·ªáu h·∫°t ph√°t s√°ng (Bloom style Project 5)
            const mat = new THREE.PointsMaterial({
                color: 0xFFD700, size: 0.8, transparent: true,
                blending: THREE.AdditiveBlending, depthWrite: false
            });

            particles = new THREE.Points(geo, mat);
            scene.add(particles);

            animate();
        }

        function initAI() {
            // MediaPipe Logic t·ª´ Project 8
            const video = document.getElementsByClassName('input_video')[0];
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8 });

            hands.onResults(results => {
                const hint = document.getElementById('gesture-hint');
                if (results.multiHandLandmarks && results.multiHandLandmarks.length === 2) {
                    state = 'HEART';
                    hint.innerText = "‚ù§Ô∏è Sending Love to You ‚ù§Ô∏è";
                    gsap.to(particles.material.color, { r: 1, g: 0.2, b: 0.5 }); // Sang m√†u h·ªìng Project 5
                } else if (results.multiHandLandmarks && results.multiHandLandmarks.length === 1) {
                    state = 'NEURAL';
                    hint.innerText = "‚ú® Connected in our Souls ‚ú®";
                    gsap.to(particles.material.color, { r: 0.4, g: 0.7, b: 1 }); // Sang xanh Project 7
                } else {
                    state = 'TREE';
                    hint.innerText = "üñê X√≤e tay: M·∫°ng l∆∞·ªõi | ü´∂ 2 tay: Tr√°i tim";
                    gsap.to(particles.material.color, { r: 1, g: 0.84, b: 0 }); // V√†ng kim Project 6
                }
            });

            const camera = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 640, height: 480
            });
            camera.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            const time = clock.getElapsedTime();
            const p = particles.geometry.attributes.position.array;
            let target = goldData;

            if (state === 'HEART') target = heartData;
            else if (state === 'NEURAL') target = neuralData;

            // Hi·ªáu ·ª©ng Morph m∆∞·ª£t m√† (Project 5 & 7 logic)
            for(let i=0; i<p.length; i++) {
                p[i] += (target[i] - p[i]) * 0.08;
                // Th√™m m·ªôt ch√∫t Noise t·ª´ Project 7 ƒë·ªÉ h·∫°t sinh ƒë·ªông
                if(state === 'NEURAL') p[i] += Math.sin(time + i) * 0.05;
            }

            particles.geometry.attributes.position.needsUpdate = true;
            particles.rotation.y += 0.005;
            
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>